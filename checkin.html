<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แก้ไขโปรไฟล์</title>
    <!-- นำเข้า Tailwind CSS สำหรับการออกแบบ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- นำเข้า LIFF SDK สำหรับการเชื่อมต่อกับ LINE -->
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <!-- นำเข้า SweetAlert2 สำหรับการแสดงการแจ้งเตือน -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-slate-100 flex items-center justify-center h-screen p-6">
    <div class="max-w-lg w-full bg-white text-slate-800 p-10 rounded-xl shadow-md">
        <h2 class="text-lg text-center mb-4">แก้ไขโปรไฟล์ผู้ป่วย</h2>
        <form id="edit-form">
            <!-- ช่องสำหรับเก็บข้อมูล ID และ UserlineId ซ่อนอยู่ -->
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-userlineId">

            <!-- ส่วนแสดงข้อมูล -->
            <div class="mb-4 flex flex-col">
                <!-- เลขประจำตัวผู้ป่วย -->
                <div class="mb-4">
                    <label for="edit-patientId" class="block text-sm">เลขประจำตัวผู้ป่วย</label>
                    <input type="text" id="edit-patientId" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
                <!-- ชื่อ-สกุล -->
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm">ชื่อ-สกุล</label>
                    <input type="text" id="edit-name" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
                <!-- เพศ -->
                <div class="mb-4">
                    <label for="edit-gender" class="block text-sm">เพศ</label>
                    <select id="edit-gender" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                        <option value="" disabled>เลือกเพศ</option>
                        <option value="ชาย">ชาย</option>
                        <option value="หญิง">หญิง</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
                <!-- วันเกิด -->
                <div class="mb-4">
                    <label for="edit-birthdate" class="block text-sm">วันเกิด</label>
                    <input type="date" id="edit-birthdate" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
                <!-- ที่อยู่ -->
                <div class="mb-4">
                    <label for="edit-address" class="block text-sm">ที่อยู่</label>
                    <textarea id="edit-address" class="w-full text-slate-800 border px-2 py-1 rounded-xl" rows="3" required disabled></textarea>
                </div>
                <!-- เบอร์โทร -->
                <div class="mb-4">
                    <label for="edit-phone" class="block text-sm">เบอร์โทร</label>
                    <input type="tel" pattern="[0-9]{10}" id="edit-phone" class="w-full text-slate-800 border px-2 py-1 rounded-xl" placeholder="เบอร์โทร (10 หลัก)" required disabled>
                </div>
                <!-- ระดับการศึกษา -->
                <div class="mb-4">
                    <label for="edit-educationLevel" class="block text-sm">ระดับการศึกษา</label>
                    <input type="text" id="edit-educationLevel" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
                <!-- อาชีพ -->
                <div class="mb-4">
                    <label for="edit-occupation" class="block text-sm">อาชีพ</label>
                    <input type="text" id="edit-occupation" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
                <!-- สถานภาพสมรส -->
                <div class="mb-4">
                    <label for="edit-maritalStatus" class="block text-sm">สถานภาพสมรส</label>
                    <select id="edit-maritalStatus" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                        <option value="" disabled>เลือกสถานภาพสมรส</option>
                        <option value="โสด">โสด</option>
                        <option value="สมรส">สมรส</option>
                        <option value="หย่าร้าง">หย่าร้าง</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
                <!-- สิทธิการรักษา -->
                <div class="mb-6">
                    <label for="edit-medicalRights" class="block text-sm">สิทธิการรักษา</label>
                    <input type="text" id="edit-medicalRights" class="w-full text-slate-800 border px-2 py-1 rounded-xl" required disabled>
                </div>
            </div>

            <!-- ปุ่มสำหรับแก้ไขข้อมูล ยกเลิก และบันทึก -->
            <div class="flex justify-end">
                <button type="button" id="edit-button" class="bg-yellow-500 text-white py-1 px-3 rounded-xl hover:bg-yellow-700">แก้ไข</button>
                <button type="button" id="cancel-button" class="bg-red-500 text-white py-1 px-3 rounded-xl hover:bg-red-700 mr-2 hidden">ยกเลิก</button>
                <button type="submit" id="save-button" class="bg-blue-500 text-white py-1 px-3 rounded-xl hover:bg-blue-700 hidden">บันทึก</button>
            </div>
        </form>
    </div>

    <script>
const WEB_APP_MEMBER_URL = 'https://script.google.com/macros/s/AKfycbzqRpgHfR6FhsAPSylanLgCdvv18vXcxTv--6X-52imoyEo3RIyfkqy1ggRz-IVKZORkg/exec';
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbySKd9ZARwWl7gxVyeqv1erpSoBz8DOWd868hz4xmqRUGLwRfCZFXuC1kAJYRG8I3Uq/exec';
    const LIFF_ID = '2005732932-l3BJMr8k'; // Liff ID
        let latestData = {};

        // เริ่มต้นด้วยการล็อกฟอร์มและซ่อนปุ่ม
        window.onload = async () => {
            await initializeLiff(); // เริ่มต้น LIFF และค้นหาข้อมูลทันทีที่ได้ userId
            toggleFormEditing(false); // ล็อกฟอร์มในตอนเริ่มต้นและซ่อนปุ่ม
        };

        // ฟังก์ชันสำหรับเริ่มต้น LIFF
        async function initializeLiff() {
            try {
                await liff.init({ liffId: `${LIFF_ID}` }); // ใส่ LIFF ID ของคุณที่นี่
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    const userlineId = profile.userId; // ดึง userId จากโปรไฟล์
                    searchDataByUserlineId(userlineId); // ค้นหาข้อมูลตาม userId
                } else {
                    liff.login(); // ถ้ายังไม่ได้เข้าสู่ระบบ ให้เข้าสู่ระบบ
                }
            } catch (error) {
                console.error('LIFF Initialization failed', error);
            }
        }

        // ฟังก์ชันค้นหาข้อมูลตาม userlineId
        async function searchDataByUserlineId(userlineId) {
            // แสดง loading spinner
            Swal.fire({
                title: 'Loading...',
                text: 'กำลังค้นหาข้อมูล กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // แสดง spinner
                }
            });

            try {
                const response = await fetch(`${WEB_APP_MEMBER_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'fetchData', userlineId: userlineId })
                });
                const data = await response.json();

                if (data && data['เลขที่']) {
                    latestData = data;

                    // กรอกข้อมูลลงในฟอร์ม
                    document.getElementById('edit-id').value = data['เลขที่'] || '';
                    document.getElementById('edit-userlineId').value = data['ไอดีไลน์'] || '';
                    document.getElementById('edit-patientId').value = data['เลขประจำตัวผู้ป่วย'] || '';
                    document.getElementById('edit-name').value = data['ชื่อ-สกุล'] || '';
                    document.getElementById('edit-gender').value = data['เพศ'] || '';
                    document.getElementById('edit-birthdate').value = data['วันเกิด'] || '';
                    document.getElementById('edit-address').value = data['ที่อยู่'] || '';
                    document.getElementById('edit-phone').value = data['เบอร์โทร'] || '';
                    document.getElementById('edit-educationLevel').value = data['ระดับการศึกษา'] || '';
                    document.getElementById('edit-occupation').value = data['อาชีพ'] || '';
                    document.getElementById('edit-maritalStatus').value = data['สถานภาพสมรส'] || '';
                    document.getElementById('edit-medicalRights').value = data['สิทธิการรักษา'] || '';
                } else {
                    Swal.fire({
                        title: 'ไม่พบข้อมูล',
                        text: 'ไม่พบข้อมูลที่ตรงกับ UserLineID นี้',
                        icon: 'warning',
                        confirmButtonText: 'OK'
                    });
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด',
                    text: 'ไม่สามารถดึงข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                // ปิด loading spinner
                Swal.close();
            }
        }

        // ฟังก์ชันสำหรับล็อกหรือปลดล็อกฟอร์มและจัดการการแสดงผลปุ่ม
        function toggleFormEditing(enable) {
            const inputs = document.querySelectorAll('#edit-form input, #edit-form select, #edit-form textarea');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');
            const editButton = document.getElementById('edit-button');

            inputs.forEach(input => {
                if (input.type !== 'hidden') { // ไม่ล็อกฟิลด์ซ่อน
                    input.disabled = !enable; // ปลดล็อก input
                }
            });

            if (enable) {
                saveButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');
                editButton.classList.add('hidden'); // ซ่อนปุ่ม Edit เมื่อทำการแก้ไข
            } else {
                saveButton.classList.add('hidden');
                cancelButton.classList.add('hidden');
                editButton.classList.remove('hidden'); // แสดงปุ่ม Edit
            }
        }

        // เพิ่ม event listener สำหรับปุ่มแก้ไขข้อมูล
        document.getElementById('edit-button').addEventListener('click', function () {
            toggleFormEditing(true); // ปลดล็อกฟอร์มเมื่อกดปุ่มแก้ไข
        });

        // เพิ่ม event listener สำหรับปุ่มยกเลิกการแก้ไข
        document.getElementById('cancel-button').addEventListener('click', function () {
            cancelEdit();
        });

        // ฟังก์ชันสำหรับส่งฟอร์มและบันทึกข้อมูล
        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;
            const userlineId = document.getElementById('edit-userlineId').value;
            const patientId = document.getElementById('edit-patientId').value.trim();
            const name = document.getElementById('edit-name').value.trim();
            const gender = document.getElementById('edit-gender').value;
            const birthdate = document.getElementById('edit-birthdate').value;
            const address = document.getElementById('edit-address').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const educationLevel = document.getElementById('edit-educationLevel').value.trim();
            const occupation = document.getElementById('edit-occupation').value.trim();
            const maritalStatus = document.getElementById('edit-maritalStatus').value;
            const medicalRights = document.getElementById('edit-medicalRights').value.trim();

            // การตรวจสอบข้อมูลเบื้องต้น
            if (!patientId || !name || !gender || !birthdate || !address || !phone || !educationLevel || !occupation || !maritalStatus || !medicalRights) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'กรุณากรอกข้อมูลในช่องที่จำเป็น.',
                });
                return;
            }

            // แสดงผลการโหลด
            Swal.fire({
                title: 'Saving data...',
                text: 'กรุณารอสักครู่...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // แสดง spinner
                }
            });

            try {
                const payload = {
                    method: 'updateData',
                    id: id,
                    userID: userlineId,
                    patientId: patientId,
                    name: name,
                    gender: gender,
                    birthdate: birthdate,
                    address: address,
                    phone: phone,
                    educationLevel: educationLevel,
                    occupation: occupation,
                    maritalStatus: maritalStatus,
                    medicalRights: medicalRights
                };

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();

                // ตรวจสอบผลลัพธ์ที่ได้รับ
                if (result && result.includes('Data updated')) {
                    Swal.fire({
                        title: 'สำเร็จ!',
                        text: 'แก้ไขข้อมูลของคุณเรียบร้อยแล้ว!',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        toggleFormEditing(false);
                        // รีเฟรชข้อมูล
                        searchDataByUserlineId(userlineId);
                    });
                } else {
                    throw new Error(result || 'Failed to save data');
                }

            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'เกิดข้อผิดพลาดขณะบันทึกข้อมูล.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });

        // ฟังก์ชันยกเลิกการแก้ไขและรีเซ็ตฟอร์ม
        function cancelEdit() {
            // รีเซ็ตฟอร์มและกรอกข้อมูลล่าสุดใหม่
            document.getElementById('edit-form').reset();
            document.getElementById('edit-id').value = latestData['เลขที่'] || '';
            document.getElementById('edit-userlineId').value = latestData['ไอดีไลน์'] || '';
            document.getElementById('edit-patientId').value = latestData['เลขประจำตัวผู้ป่วย'] || '';
            document.getElementById('edit-name').value = latestData['ชื่อ-สกุล'] || '';
            document.getElementById('edit-gender').value = latestData['เพศ'] || '';
            document.getElementById('edit-birthdate').value = latestData['วันเกิด'] || '';
            document.getElementById('edit-address').value = latestData['ที่อยู่'] || '';
            document.getElementById('edit-phone').value = latestData['เบอร์โทร'] || '';
            document.getElementById('edit-educationLevel').value = latestData['ระดับการศึกษา'] || '';
            document.getElementById('edit-occupation').value = latestData['อาชีพ'] || '';
            document.getElementById('edit-maritalStatus').value = latestData['สถานภาพสมรส'] || '';
            document.getElementById('edit-medicalRights').value = latestData['สิทธิการรักษา'] || '';

            toggleFormEditing(false); // ล็อกฟอร์มอีกครั้งหลังจากรีเซ็ต
        }
    </script>
</body>

</html>
