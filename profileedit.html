<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data from Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>

<body class="bg-gray-300 p-6">
    <div class="max-w-lg m-auto bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-xl mb-4">แก้ไขข้อมูลพนักงาน</h2>
        <div class="flex justify-end mb-4">
            <button type="button" id="edit-button" class="bg-yellow-500 text-white py-1 px-3 rounded hover:bg-yellow-700">แก้ไข</button>
        </div>
        <form id="edit-form">
            <input type="hidden" id="edit-id">
            <div class="mb-4 hidden">
                <label for="edit-userID" class="block text-sm">UserID</label>
                <input type="text" id="edit-userID" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="mb-4">
                <label for="edit-imageUrl" class="block text-sm">URL รูปภาพ</label>
                <input type="text" id="edit-imageUrl" class="w-full border px-2 py-1 rounded" oninput="updateImagePreview()" disabled>
                <img id="image-preview" src="" alt="Image Preview" class="mt-2 max-h-40 rounded">
            </div>
            <div class="mb-4">
                <label for="edit-image" class="block text-sm">อัปโหลดรูปภาพ</label>
                <input type="file" id="edit-image" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="mb-4">
                <label for="edit-name" class="block text-sm">ชื่อพนักงาน</label>
                <input type="text" id="edit-name" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="mb-4">
                <label for="edit-employeeID" class="block text-sm">รหัสพนักงาน</label>
                <input type="text" id="edit-employeeID" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="mb-4">
                <label for="edit-department" class="block text-sm">แผนก</label>
                <input type="text" id="edit-department" class="w-full border px-2 py-1 rounded" disabled>
            </div>
            <div class="flex justify-end">
                <button type="button" class="bg-red-500 text-white py-1 px-3 rounded hover:bg-red-700 mr-2 hidden" onclick="resetForm()">Reset</button>
                <button type="submit" class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-700 hidden">Save</button>
            </div>
        </form>
    </div>

    <script>
        const LIFF_ID = '2006041930-4JQAqNYj'; // Liff ID
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyImoE0rNW7mG7kStGH-TE32wepRuo_maLY3V7N6szaOVU2KJ8Co646DvKjkIjc3MVs/exec';
        let latestData = {};

        // ฟังก์ชันนี้จะถูกเรียกใช้เมื่อโหลดหน้าเว็บเสร็จสมบูรณ์
        window.onload = async function () {
            await initializeLiff();
        };

        // ฟังก์ชันนี้ใช้ในการเริ่มต้น LIFF (LINE Front-end Framework)
        async function initializeLiff() {
            try {
                // เริ่มต้น LIFF โดยใช้ LIFF ID ที่กำหนด
                await liff.init({ liffId: `${LIFF_ID}` });
                // ถ้าผู้ใช้ได้เข้าสู่ระบบแล้ว จะดึงข้อมูลโปรไฟล์
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    // ถ้ายังไม่ได้เข้าสู่ระบบ จะพาผู้ใช้ไปที่หน้าล็อกอิน
                    liff.login();
                }
            } catch (error) {
                // ถ้ามีข้อผิดพลาดในขณะเริ่มต้น LIFF จะทำการล็อกข้อผิดพลาดในคอนโซล
                console.error('Error initializing LIFF:', error);
            }
        }

        // ฟังก์ชันนี้ดึงข้อมูลโปรไฟล์ของผู้ใช้จาก LIFF
        async function getUserProfile() {
            try {
                // รับข้อมูลโปรไฟล์ของผู้ใช้
                const profile = await liff.getProfile();
                const userId = profile.userId;
                // กำหนดค่า userId และ displayName ในฟอร์ม
                document.getElementById('edit-userID').value = userId;
                // ดึงข้อมูลเพิ่มเติมโดยใช้ userId
                await fetchData(userId);
            } catch (error) {
                // ถ้ามีข้อผิดพลาดในการดึงข้อมูลโปรไฟล์ จะทำการล็อกข้อผิดพลาดในคอนโซล
                console.error('Error getting profile data:', error);
            }
        }

        // ฟังก์ชันนี้ดึงข้อมูลเพิ่มเติมจาก Google Apps Script โดยใช้ userId
        async function fetchData(userId) {
            showLoading(true); // แสดงหน้าต่างโหลด
            try {
                // ส่งคำขอไปยัง Google Apps Script เพื่อดึงข้อมูล
                const response = await fetch(`${WEB_APP_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'fetchData', userId: userId })
                });
                const data = await response.json();
                // กรองแถวที่มี userId ตรงกับที่ต้องการ
                const userRows = data.filter(row => row[1] === userId);
                if (userRows.length > 0) {
                    // เรียงลำดับข้อมูลตามวันที่ (สมมติว่าอยู่ในคอลัมน์ที่ 7) จากล่าสุดไปเก่าสุด
                    userRows.sort((a, b) => new Date(b[6]) - new Date(a[6]));
                    displayData(userRows[0]);  // แสดงข้อมูลล่าสุด
                } else {
                    // ถ้าไม่มีข้อมูลที่ตรงกับ userId จะแสดงข้อความในคอนโซล
                    console.log('No data found for userId:', userId);
                }
            } catch (error) {
                // ถ้ามีข้อผิดพลาดในการดึงข้อมูล จะทำการล็อกข้อผิดพลาดในคอนโซล
                console.error('Error fetching data:', error);
            } finally {
                showLoading(false); // ซ่อนหน้าต่างโหลด
            }
        }

        // ฟังก์ชันนี้ใช้ในการแสดงข้อมูลที่ได้จาก fetchData ลงในฟอร์ม
        function displayData(row) {
            document.getElementById('edit-id').value = row[0] || '';
            document.getElementById('edit-name').value = row[2] || '';
            document.getElementById('edit-employeeID').value = row[3] || '';
            document.getElementById('edit-department').value = row[4] || '';
            document.getElementById('edit-imageUrl').value = row[5] || '';
            document.getElementById('image-preview').src = row[5] || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png';
        }

        // ฟังก์ชันสำหรับล็อกหรือปลดล็อกฟอร์มและจัดการการแสดงผลปุ่ม
        function toggleFormEditing(enable) {
            const inputs = document.querySelectorAll('#edit-form input');
            const saveButton = document.querySelector('#edit-form button[type="submit"]');
            const resetButton = document.querySelector('#edit-form button[type="button"]');

            inputs.forEach(input => {
                input.disabled = !enable; // ปลดล็อก input
            });

            if (enable) {
                saveButton.classList.remove('hidden');
                resetButton.classList.remove('hidden');
            } else {
                saveButton.classList.add('hidden');
                resetButton.classList.add('hidden');
            }
        }

        document.getElementById('edit-button').addEventListener('click', function() {
            toggleFormEditing(true); // ปลดล็อกฟอร์มเมื่อกดปุ่มแก้ไข
            this.classList.add('hidden'); // ซ่อนปุ่มแก้ไขหลังจากปลดล็อกฟอร์ม
        });

        document.getElementById('edit-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const id = document.getElementById('edit-id').value;
            const userID = document.getElementById('edit-userID').value;
            const name = document.getElementById('edit-name').value;
            const employeeID = document.getElementById('edit-employeeID').value;
            const department = document.getElementById('edit-department').value;
            const imageFile = document.getElementById('edit-image').files[0];

            let imageUrl = document.getElementById('edit-imageUrl').value;

            // แสดงผลการโหลด
            Swal.fire({
                title: 'Saving data...',
                text: 'Please wait while we save your data.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // แสดง spinner
                }
            });

            try {
                if (imageFile) {
                    const base64Image = await getBase64(imageFile); // แปลงไฟล์เป็น Base64
                    await updateData(id, userID, name, employeeID, department, base64Image);
                } else {
                    await updateData(id, userID, name, employeeID, department, imageUrl);
                }

                Swal.fire({
                    title: 'Success',
                    text: 'Data saved successfully!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                await fetchData(userID); // อัปเดตข้อมูลในฟอร์มหลังจากบันทึกข้อมูลสำเร็จ

            } catch (error) {
                console.error('Error saving data:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to save data. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            } finally {
                resetForm();
            }
        });

        // ฟังก์ชันรีเซ็ตฟอร์มและล็อกฟอร์มใหม่
        function resetForm() {
            document.getElementById('edit-form').reset();
            document.getElementById('edit-id').value = latestData[0];
            document.getElementById('edit-userID').value = latestData[1];
            document.getElementById('edit-name').value = latestData[2];
            document.getElementById('edit-employeeID').value = latestData[3];
            document.getElementById('edit-department').value = latestData[4];
            document.getElementById('edit-imageUrl').value = latestData[5];

            updateImagePreview(); // อัปเดตการแสดงผลของรูปภาพ
            toggleFormEditing(false); // ล็อกฟอร์มอีกครั้งหลังจากรีเซ็ต
            document.getElementById('edit-button').classList.remove('hidden'); // แสดงปุ่มแก้ไขอีกครั้ง
        }

        // ฟังก์ชันอัปเดตข้อมูล
        async function updateData(id, userID, name, employeeID, department, base64Image) {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `method=updateData&id=${id}&userID=${encodeURIComponent(userID)}&name=${encodeURIComponent(name)}&employeeID=${encodeURIComponent(employeeID)}&department=${encodeURIComponent(department)}&imageUrl=${encodeURIComponent(base64Image)}`
            });
            const result = await response.text();
            return result;
        }

        // ฟังก์ชันสำหรับแปลงไฟล์เป็น Base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                let reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // ฟังก์ชันแสดงหน้าต่างโหลด
        function showLoading(show) {
            if (show) {
                Swal.fire({
                    title: 'Loading...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            } else {
                Swal.close();
            }
        }
    </script>
</body>

</html>
